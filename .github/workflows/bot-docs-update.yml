name: Bot - Documentation Update

on:
  push:
    branches: [main, master]
    paths:
      - 'src/**'
      - 'lib/**'
      - '*.md'
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday

permissions:
  contents: write
  pull-requests: write

jobs:
  update-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check README exists
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            if (!fs.existsSync('README.md')) {
              const template = `# ${context.repo.repo}

## Overview
[Add project description]

## Installation
\`\`\`bash
npm install
\`\`\`

## Usage
[Add usage instructions]

## Contributing
See CONTRIBUTING.md

## License
[Add license]

---
 Generated by BlackRoad Bot System
`;

              fs.writeFileSync('README.md', template);

              await github.rest.repos.createOrUpdateFileContents({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: 'README.md',
                message: ' docs: Add README template',
                content: Buffer.from(template).toString('base64')
              });
            }

      - name: Generate API docs
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Simple JSDoc extraction
            function extractDocs(filePath) {
              const content = fs.readFileSync(filePath, 'utf8');
              const docRegex = /\/\*\*([\s\S]*?)\*\/\s*(?:export\s+)?(?:async\s+)?function\s+(\w+)/g;
              const docs = [];

              let match;
              while ((match = docRegex.exec(content)) !== null) {
                docs.push({
                  name: match[2],
                  doc: match[1].trim()
                });
              }

              return docs;
            }

            function scanForFunctions(dir) {
              const docs = [];
              const entries = fs.readdirSync(dir, { withFileTypes: true });

              for (const entry of entries) {
                const fullPath = path.join(dir, entry.name);

                if (entry.name.startsWith('.') || entry.name === 'node_modules') {
                  continue;
                }

                if (entry.isDirectory()) {
                  docs.push(...scanForFunctions(fullPath));
                } else if (entry.name.endsWith('.js') || entry.name.endsWith('.ts')) {
                  docs.push(...extractDocs(fullPath));
                }
              }

              return docs;
            }

            if (fs.existsSync('src')) {
              const docs = scanForFunctions('src');

              if (docs.length > 0) {
                let apiDoc = '# API Documentation\n\n';
                apiDoc += '> Auto-generated from source code\n\n';

                for (const doc of docs) {
                  apiDoc += `## ${doc.name}\n\n`;
                  apiDoc += doc.doc.replace(/\s*\*\s*/g, '\n') + '\n\n';
                }

                apiDoc += '\n---\n Generated by BlackRoad Bot System\n';

                fs.writeFileSync('API.md', apiDoc);

                console.log(`Generated API documentation with ${docs.length} functions`);
              }
            }

      - name: Update documentation links
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            if (fs.existsSync('README.md')) {
              let readme = fs.readFileSync('README.md', 'utf8');

              // Add links section if missing
              if (!readme.includes('## Links') && !readme.includes('## Resources')) {
                const links = `

## Links

- [Documentation](https://docs.blackroad.io)
- [API Reference](./API.md)
- [Contributing](./CONTRIBUTING.md)
- [BlackRoad OS](https://github.com/BlackRoad-OS)
`;
                readme += links;
                fs.writeFileSync('README.md', readme);
              }
            }

      - name: Create PR for doc updates
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Check if we made changes
            const { execSync } = require('child_process');
            const status = execSync('git status --porcelain').toString();

            if (status.trim()) {
              const branchName = `bot/docs-update-${Date.now()}`;

              execSync(`git config user.name "BlackRoad Bot"`);
              execSync(`git config user.email "bot@blackroad.io"`);
              execSync(`git checkout -b ${branchName}`);
              execSync(`git add .`);
              execSync(`git commit -m " docs: Auto-update documentation"`);
              execSync(`git push origin ${branchName}`);

              await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: ' docs: Auto-update documentation',
                body: `## Documentation Updates

This PR includes automated documentation updates:
- README improvements
- API documentation generation
- Link updates

**Generated by:** BlackRoad Bot System
**Review:** Please verify changes before merging

cc: @${context.repo.owner}`,
                head: branchName,
                base: 'main'
              });
            }

      - name: Log to memory
        run: |
          if [ -f ~/memory-system.sh ]; then
            ~/memory-system.sh log bot-action "docs-update" "Documentation updated for ${{ github.repository }}"
          fi
