name: Trinity Compliance Check

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight

jobs:
  check-compliance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Trinity Structure
        run: |
          echo "ðŸŒˆ Light Trinity Compliance Check"
          echo "================================="
          echo ""

          ERRORS=0

          # Check .trinity/ exists
          if [ ! -d ".trinity" ]; then
            echo "âŒ CRITICAL: .trinity/ directory missing"
            ERRORS=$((ERRORS + 1))
          else
            echo "âœ… .trinity/ directory present"
          fi

          # Check RedLight
          echo ""
          echo "ðŸ”´ Checking RedLight..."
          if [ ! -d ".trinity/redlight" ]; then
            echo "   âŒ RedLight directory missing"
            ERRORS=$((ERRORS + 1))
          else
            echo "   âœ… RedLight directory present"

            # Count templates
            if [ -d ".trinity/redlight/templates" ]; then
              template_count=$(find .trinity/redlight/templates -name "*.html" 2>/dev/null | wc -l)
              echo "   ðŸ“„ Found $template_count HTML templates"
              if [ "$template_count" -lt 10 ]; then
                echo "   âš ï¸  Warning: Expected at least 10 templates, found $template_count"
              fi
            else
              echo "   âŒ Templates directory missing"
              ERRORS=$((ERRORS + 1))
            fi

            # Check docs
            if [ -f ".trinity/redlight/docs/REDLIGHT_TEMPLATE_SYSTEM.md" ]; then
              echo "   âœ… Documentation present"
            else
              echo "   âŒ Documentation missing"
              ERRORS=$((ERRORS + 1))
            fi
          fi

          # Check GreenLight
          echo ""
          echo "ðŸ’š Checking GreenLight..."
          if [ ! -d ".trinity/greenlight" ]; then
            echo "   âŒ GreenLight directory missing"
            ERRORS=$((ERRORS + 1))
          else
            echo "   âœ… GreenLight directory present"

            # Count docs
            if [ -d ".trinity/greenlight/docs" ]; then
              doc_count=$(find .trinity/greenlight/docs -name "*.md" 2>/dev/null | wc -l)
              echo "   ðŸ“š Found $doc_count documentation files"
              if [ "$doc_count" -lt 10 ]; then
                echo "   âš ï¸  Warning: Expected at least 10 docs, found $doc_count"
              fi
            else
              echo "   âŒ Docs directory missing"
              ERRORS=$((ERRORS + 1))
            fi

            # Check template script
            if [ -f ".trinity/greenlight/scripts/memory-greenlight-templates.sh" ]; then
              echo "   âœ… Template script present"

              # Count templates in script
              template_funcs=$(grep -c "^gl_" .trinity/greenlight/scripts/memory-greenlight-templates.sh 2>/dev/null || echo "0")
              echo "   ðŸ”§ Found $template_funcs template functions"
            else
              echo "   âŒ Template script missing"
              ERRORS=$((ERRORS + 1))
            fi
          fi

          # Check YellowLight
          echo ""
          echo "ðŸ’› Checking YellowLight..."
          if [ ! -d ".trinity/yellowlight" ]; then
            echo "   âŒ YellowLight directory missing"
            ERRORS=$((ERRORS + 1))
          else
            echo "   âœ… YellowLight directory present"

            # Check docs
            if [ -f ".trinity/yellowlight/docs/YELLOWLIGHT_INFRASTRUCTURE_SYSTEM.md" ]; then
              echo "   âœ… Documentation present"
            else
              echo "   âŒ Documentation missing"
              ERRORS=$((ERRORS + 1))
            fi

            # Check scripts
            script_count=$(find .trinity/yellowlight/scripts -name "*.sh" 2>/dev/null | wc -l)
            echo "   ðŸ”§ Found $script_count infrastructure scripts"
          fi

          # Check Trinity System
          echo ""
          echo "ðŸŒˆ Checking Trinity System..."
          if [ ! -d ".trinity/system" ]; then
            echo "   âŒ System directory missing"
            ERRORS=$((ERRORS + 1))
          else
            echo "   âœ… System directory present"

            # Check core docs
            if [ -f ".trinity/system/THE_LIGHT_TRINITY.md" ]; then
              echo "   âœ… Trinity overview present"
            else
              echo "   âŒ Trinity overview missing"
              ERRORS=$((ERRORS + 1))
            fi

            if [ -f ".trinity/system/LIGHT_TRINITY_ENFORCEMENT.md" ]; then
              echo "   âœ… Enforcement docs present"
            else
              echo "   âŒ Enforcement docs missing"
              ERRORS=$((ERRORS + 1))
            fi
          fi

          # Check README
          echo ""
          echo "ðŸ“– Checking README..."
          if [ -f ".trinity/README.md" ]; then
            echo "   âœ… Trinity README present"
          else
            echo "   âš ï¸  Warning: Trinity README missing"
          fi

          # Summary
          echo ""
          echo "================================="
          if [ $ERRORS -eq 0 ]; then
            echo "âœ… Trinity compliance check PASSED"
            echo "ðŸŒˆ All three lights present and functional"
            exit 0
          else
            echo "âŒ Trinity compliance check FAILED"
            echo "ðŸ”¥ Found $ERRORS critical issues"
            echo ""
            echo "To fix, see: .trinity/README.md"
            echo "Source of truth: https://github.com/blackroad-os/blackroad-os-infra"
            exit 1
          fi

      - name: Run Trinity Tests
        if: success()
        run: |
          if [ -f ".trinity/system/trinity-record-test.sh" ]; then
            echo "ðŸ§ª Running Trinity tests..."
            bash .trinity/system/trinity-record-test.sh
          else
            echo "âš ï¸  No test script found, skipping tests"
          fi

      - name: Generate Compliance Report
        if: always()
        run: |
          echo "ðŸ“Š Trinity Compliance Report" > trinity-report.txt
          echo "============================" >> trinity-report.txt
          echo "" >> trinity-report.txt
          echo "Repository: ${{ github.repository }}" >> trinity-report.txt
          echo "Branch: ${{ github.ref_name }}" >> trinity-report.txt
          echo "Commit: ${{ github.sha }}" >> trinity-report.txt
          echo "Date: $(date -u)" >> trinity-report.txt
          echo "" >> trinity-report.txt

          # Structure check
          echo "Structure:" >> trinity-report.txt
          echo "  RedLight: $([ -d .trinity/redlight ] && echo 'âœ…' || echo 'âŒ')" >> trinity-report.txt
          echo "  GreenLight: $([ -d .trinity/greenlight ] && echo 'âœ…' || echo 'âŒ')" >> trinity-report.txt
          echo "  YellowLight: $([ -d .trinity/yellowlight ] && echo 'âœ…' || echo 'âŒ')" >> trinity-report.txt
          echo "  System: $([ -d .trinity/system ] && echo 'âœ…' || echo 'âŒ')" >> trinity-report.txt
          echo "" >> trinity-report.txt

          # File counts
          echo "File Counts:" >> trinity-report.txt
          echo "  RedLight templates: $(find .trinity/redlight/templates -name '*.html' 2>/dev/null | wc -l)" >> trinity-report.txt
          echo "  GreenLight docs: $(find .trinity/greenlight/docs -name '*.md' 2>/dev/null | wc -l)" >> trinity-report.txt
          echo "  YellowLight scripts: $(find .trinity/yellowlight/scripts -name '*.sh' 2>/dev/null | wc -l)" >> trinity-report.txt

          cat trinity-report.txt

      - name: Upload Compliance Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trinity-compliance-report
          path: trinity-report.txt
          retention-days: 30
